from asm.create_data.generate_dataset import get_dataset

import torch
import torch.utils.data


def test_model(name, model_path):
    """
    Test the specified model.
    :param name: The name of the model (LSTM_DPCNN, DPCNN or LSTM).
    :param model_path: The path to load model.
    :return: The accuracy of the model.
    """
    # test_path = input("Please input the path of test data: ")
    test_path = "E:/malware/vec/test"
    if test_path[-1] != '/':
        test_path += '/'

    dataset = get_dataset(test_path)

    model = torch.load(model_path).cuda()

    test_loader = torch.utils.data.dataloader.DataLoader(dataset, batch_size=28)

    # Calculate the accuracy
    correct = torch.zeros(1).squeeze().cuda()
    total = torch.zeros(1).squeeze().cuda()

    for i, data in enumerate(test_loader):
        x, y = data

        if name == "LSTM" or name == "LSTM_DPCNN":
            x = torch.unsqueeze(x, 1).cuda()
        else:
            x = torch.unsqueeze(x, 2).cuda()

        y = torch.unsqueeze(y, 1).cuda()

        x_var = torch.autograd.Variable(x)

        output = model(x_var)

        prediction = torch.argmax(output, 1)

        correct += (prediction == y.long()).sum().float()
        total += len(y)

    accuracy = (correct / total).cpu()

    print(accuracy)

    return accuracy
