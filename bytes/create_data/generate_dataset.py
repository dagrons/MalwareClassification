import os
import shutil
import pandas as pd
import torch
import random

from PIL import Image
from torch.utils.data import Dataset
from bytes.create_data.bytes2img import *


class MalwareData(torch.utils.data.Dataset):
    def __init__(self, images, labels):
        self.images = images
        self.labels = labels

    def __getitem__(self, item):
        path = self.images[item]
        label = self.labels[item]

        image = Image.open(path)
        image = image.resize((224, 224))
        mat = np.asarray(image, dtype=np.float32)
        mat = np.reshape(mat, (1, 224, 224))
        mat = np.repeat(mat, 3, axis=0)
        image_tensor = torch.from_numpy(mat)

        return image_tensor, label

    def __len__(self):
        return len(self.labels)


def split_dataset(src_path, dest_path, label_path):
    """
    Split all .bytes files into 9 categories, each category representing a family.
    :param src_path: The path of all .bytes files.
    :param dest_path: The path of 9 categories.
    :param label_path: The path of labels.csv.
    """
    # Read labels.csv
    df = pd.read_csv(label_path)

    if not os.path.exists(dest_path):
        os.mkdir(dest_path)
    # Split dataset into 9 categories
    for i in range(1, 10):

        filename_list = df.Id[df['Class'] == i].tolist()
        # Delete the same file names
        filename_list = list(set(filename_list))
        if not os.path.exists(dest_path + str(i)):
            os.mkdir(dest_path + str(i))
        for file_name in filename_list:
            shutil.move(src_path + file_name + '.bytes', dest_path + str(i) + '/' + file_name + '.bytes')

    os.rmdir(src_path)


def generate_train_test(bytes_path):
    """
    Split all .bytes files into training samples and test samples.
    :param bytes_path: The path of all .bytes files.
    """
    train_path = '/'.join(bytes_path.split('/')[:-1]) + "/train/"
    test_path = '/'.join(bytes_path.split('/')[:-1]) + "/test/"

    dirs = os.listdir(bytes_path)
    for dir in dirs:
        files = os.listdir(bytes_path + dir)

        num = len(files)
        train_num = int(num * 0.8)

        if not os.path.exists(train_path):
            os.mkdir(train_path)
        if not os.path.exists(test_path):
            os.mkdir(test_path)
        if not os.path.exists(train_path + dir):
            os.mkdir(train_path + dir)
        if not os.path.exists(test_path + dir):
            os.mkdir(test_path + dir)

        for bytes in files[0:train_num]:
            shutil.move(bytes_path + dir + '/' + bytes, train_path + dir + '/' + bytes)
        for bytes in files[train_num:]:
            shutil.move(bytes_path + dir + '/' + bytes, test_path + dir + '/' + bytes)

        os.rmdir(bytes_path + dir)


def generate_dataset(src_path, dest_path):
    """
    Convert .bytes files to .bytes.mat files and save them as .bmp.
    :param src_path: The path of all .bytes files.
    :param dest_path: The path of all .bmp files.
    """
    dirs = os.listdir(src_path)
    for dir in dirs:
        if not os.path.exists(dest_path + dir):
            os.mkdir(dest_path + dir)
        for file in os.listdir(src_path + dir):
            mat = hex2mat(src_path + dir + '/' + file)

            if mat.size:
                img = Image.fromarray(mat)
                # convert image to bit map
                img = img.convert("L")
                img.save(dest_path + dir + '/' + file.split('.')[0] + '.bmp')


def get_dataset(src_path):
    """
    Get dataset from training path or test path.
    :param src_path: The path of .bytes files.
    :return: Training dataset or test dataset.
    """
    x = []      # the path of .bmp files
    y = []
    dirs = os.listdir(src_path)
    for dir in dirs:
        for file in os.listdir(src_path + dir):
            x.append(src_path + dir + '/' + file)
            y.append(int(dir) - 1)

    # shuffle the dataset
    temp = list(zip(x, y))
    random.shuffle(temp)
    x[:], y[:] = zip(*temp)

    return MalwareData(x, y)


if __name__ == "__main__":
    # bytes_path = 'H:/bytes/data/'
    # split_dataset('H:/bytes/dataset/', 'H:/bytes/data/', 'H:/bytes/labels.csv')
    # generate_train_test(bytes_path)
    # generate_dataset("H:/bytes/data/train/", "D:/malware/bytes/train/")
    # generate_dataset("H:/bytes/data/test/", "D:/malware/bytes/test/")
    dataset = get_dataset("D:/malware/bytes/test/")
    print(dataset)
    # print(dataset.y)
